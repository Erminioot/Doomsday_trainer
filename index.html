<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Doomsday Trainer</title>

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#ffffff">

  <style>
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      margin:14px;
      max-width:760px;
      padding-bottom:160px; /* spazio bottom bar */
    }

    .tabs{
      display:flex;
      gap:10px;
      margin:0 0 10px;
    }
    .tabBtn{
      font-size:16px;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid #bbb;
      background:#fff;
      font-weight:900;
      cursor:pointer;
    }
    .tabBtn.active{
      background:#111;
      color:#fff;
      border-color:#111;
    }

    .topLine{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin:0 2px 8px;
    }
    .topLine .spacer{flex:1;}
    .topLine label{
      font-size:14px;
      font-weight:900;
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    input[type="checkbox"],input[type="radio"]{transform:scale(1.15);}

    .card{
      border:1px solid #ddd;
      border-radius:14px;
      padding:14px;
      margin:10px 0;
      background:#fff;
    }

    /* Setup box */
    .setupTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .setupLeft{
      display:flex;
      align-items:center;
      gap:18px;
      flex-wrap:wrap;
    }
    .btnSmall{
      font-size:16px;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid #bbb;
      background:#fff;
      font-weight:900;
      cursor:pointer;
    }
    .btnSmall:disabled{opacity:.45;cursor:not-allowed;}

    .rangeGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      align-items:center;
      margin-top:10px;
    }
    label.inline{
      font-size:14px;
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:700;
    }
    input[type="number"]{
      font-size:18px;
      padding:10px;
      border-radius:10px;
      border:1px solid #ccc;
      width:120px;
    }

    .rowToggles{
      display:flex;
      align-items:center;
      gap:18px;
      margin-top:8px;
      flex-wrap:wrap;
    }
    .setupDisabled{
      opacity:.55;
      pointer-events:none;
    }

    /* Main (date + answer/quiz) */
    .mainCard{transition:background-color .12s ease;}
    .mainOk{background:#d8f9c9;}
    .mainBad{background:#ffd0d0;}

    .date{
      font-size:44px;
      font-weight:900;
      text-align:center;
      margin:14px 0 8px;
    }
    .answer{
      font-size:30px;
      font-weight:900;
      text-align:center;
      margin:8px 0 6px;
      line-height:1.1;
    }
    .leapNote{
      font-size:16px;
      font-style:italic;
      font-weight:600;
      margin-top:6px;
      color:#333;
    }
    .saveWrap{
      display:flex;
      justify-content:center;
      margin-top:10px;
    }

    /* Quiz buttons 2-3-2 */
    #quizBlock{display:none;}
    .quizRows{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin:10px auto 6px;
      max-width:560px;
    }
    .quizRow{
      display:flex;
      gap:10px;
      justify-content:center;
    }
    .quizBtn{
      flex:1;
      font-size:18px;
      padding:14px 10px;
      border-radius:12px;
      border:1px solid #bbb;
      background:#fff;
      font-weight:900;
      cursor:pointer;
      min-width:0;
    }
    .quizBtn:disabled{opacity:.45;cursor:not-allowed;}
    .quizMsg{
      text-align:center;
      font-size:44px;
      font-weight:900;
      margin:14px 0 8px;
    }

    /* Stats card (shared style) */
    #trainingStatsCard, #quizStatsCard{display:none;}
    .statsTopRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .statsTopLeft{
      font-size:16px;
      font-weight:900;
      white-space:nowrap;
    }
    .statsTopMid{
      flex:1;
      text-align:center;
      font-size:24px;
      font-weight:900;
      text-decoration:underline;
      white-space:nowrap;
    }
    .statsBox{
      border:1px solid #ddd;
      border-radius:12px;
      padding:12px 14px;
      margin-top:12px;
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:10px 18px;
    }
    .statRow{
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size:16px;
    }

    /* Verify */
    #verifyBlock{display:none;}
    .verifyRow{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:center;
      margin-top:10px;
    }
    .verifyRow input{
      font-size:20px;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid #ccc;
      width:210px;
      text-align:center;
    }
    .verifyOut{
      text-align:center;
      margin-top:14px;
      font-size:28px;
      font-weight:900;
      line-height:1.15;
    }

    /* Bottom bar */
    .bottomBar{
      position:fixed;
      left:0; right:0; bottom:160px;
      background:#fff;
      padding:10px;
      display:flex;
      justify-content:center;
      z-index:999;
      border-top:1px solid #eee;
      padding-bottom: calc(10px + env(safe-area-inset-bottom));
    }
    .bottomBar button{
      font-size:22px;
      padding:26px 22px;
      width:92%;
      max-width:520px;
      border-radius:16px;
      border:1px solid #bbb;
      background:#fff;
      cursor:pointer;
      font-weight:900;
    }
    .bottomBar button:disabled{opacity:.45;cursor:not-allowed;}
    .bottomNext{
      background:#eaf7ea;
      border-color:#1f7a1f;
    }
  </style>
</head>

<body>

  <!-- Tabs -->
  <div class="tabs">
    <button id="tabTraining" class="tabBtn active">Training</button>
    <button id="tabQuiz" class="tabBtn">Quiz</button>
    <button id="tabVerify" class="tabBtn">Verifica</button>
    <div class="spacer"></div>
  </div>

  <!-- Top right stats toggle -->
  <div class="topLine">
    <div class="spacer"></div>
    <label id="statsToggleLabel"><input id="statsToggle" type="checkbox">Attiva statistiche</label>
  </div>

  <!-- SETUP -->
  <div class="card" id="setupCard">
    <div class="setupTop">
      <div class="setupLeft" id="setupRadios"></div>
      <button id="setupClearBtn" class="btnSmall" style="display:none;">—</button>
    </div>

    <div id="rangeBlock">
      <div class="rangeGrid">
        <label class="inline">Min <input id="minY" type="number" value="1700"></label>
        <label class="inline">Max <input id="maxY" type="number" value="2199"></label>
      </div>
      <div class="rowToggles">
        <label class="inline"><input id="mode1900" type="checkbox">1900–2099</label>
        <label class="inline"><input id="fmtNum" type="checkbox">dd/mm/yyyy</label>
      </div>
    </div>
  </div>

  <!-- MAIN -->
  <div class="card mainCard" id="mainCard">
    <div class="date" id="dateOut">—</div>

    <!-- Training reveal -->
    <div id="trainingBlock">
      <div class="answer" id="answerOut"></div>
      <div class="saveWrap">
        <button id="saveBtn" class="btnSmall" style="display:none;">Salva</button>
      </div>
    </div>

    <!-- Quiz -->
    <div id="quizBlock">
      <div class="quizRows" id="quizRows"></div>
      <div class="quizMsg" id="quizMsg"></div>
    </div>

    <!-- Verify -->
    <div id="verifyBlock">
      <div class="verifyRow">
        <input id="verifyIn" type="text" inputmode="numeric" pattern="[0-9/]*" placeholder="gg/mm/aaaa">
        <button id="verifyBtn" class="btnSmall">Verifica</button>
      </div>
      <div class="verifyOut" id="verifyOut"></div>
    </div>
  </div>

  <!-- STATS -->
  <div class="card" id="trainingStatsCard">
    <div class="statsTopRow">
      <div class="statsTopLeft">Prove <span id="tNOut">0</span></div>
      <div class="statsTopMid" id="tTimeTop">—</div>
      <button id="tResetBtn" class="btnSmall">Reset</button>
    </div>
    <div class="statsBox">
      <div class="statRow"><span>Media</span><strong id="tAvgOut">—</strong></div>
      <div class="statRow"><span>Mediana</span><strong id="tMedOut">—</strong></div>
      <div class="statRow"><span>Migliore</span><strong id="tBestOut">—</strong></div>
      <div class="statRow"><span>Peggiore</span><strong id="tWorstOut">—</strong></div>
    </div>
  </div>

  <div class="card" id="quizStatsCard">
    <div class="statsTopRow">
      <div class="statsTopLeft" id="qTopLeft">—</div>
      <div class="statsTopMid" id="qTimeTop">—</div>
      <button id="qResetBtn" class="btnSmall">Reset</button>
    </div>
    <div class="statsBox">
      <div class="statRow"><span>Streak</span><strong id="qStreakOut">0</strong></div>
      <div class="statRow"><span>Best</span><strong id="qBestStreakOut">0</strong></div>
      <div class="statRow"><span>Session</span><strong id="qSessionOut">0/0</strong></div>
      <div class="statRow"><span>Errori</span><strong id="qErrCountOut">0</strong></div>

      <div class="statRow"><span>Media</span><strong id="qAvgOut">—</strong></div>
      <div class="statRow"><span>Mediana</span><strong id="qMedOut">—</strong></div>
      <div class="statRow"><span>Migliore</span><strong id="qBestOut">—</strong></div>
      <div class="statRow"><span>Peggiore</span><strong id="qWorstOut">—</strong></div>
    </div>
  </div>

  <!-- BOTTOM -->
  <div class="bottomBar" id="bottomBar">
    <button id="bottomBtn" disabled>Mostra</button>
  </div>

<script>
/* ===========================
   Helpers
=========================== */
const giorni=["Domenica","Lunedì","Martedì","Mercoledì","Giovedì","Venerdì","Sabato"];
const mesi=["gennaio","febbraio","marzo","aprile","maggio","giugno","luglio","agosto","settembre","ottobre","novembre","dicembre"];

function randInt(a,b){return Math.floor(Math.random()*(b-a+1))+a;}
function isLeap(y){return y%4===0 && (y%100!==0 || y%400===0);}
function dim(y,m){return [31,isLeap(y)?29:28,31,30,31,30,31,31,30,31,30,31][m-1];}

// Zeller (Gregorian): 0=Sun..6=Sat
function weekday(y,m,d){
  if(m<3){m+=12;y--;}
  const K=y%100;
  const J=Math.floor(y/100);
  const h=(d+Math.floor((13*(m+1))/5)+K+Math.floor(K/4)+Math.floor(J/4)+5*J)%7;
  return [6,0,1,2,3,4,5][h];
}

function fmtDate(d,m,y){
  if(fmtNum.checked){
    return String(d).padStart(2,"0")+"/"+String(m).padStart(2,"0")+"/"+y;
  }
  return d+" "+mesi[m-1]+" "+y;
}

function fmtSec(x){ return Number.isFinite(x) ? x.toFixed(2) : "—"; }
function mean(arr){ return arr.length ? arr.reduce((s,v)=>s+v,0)/arr.length : NaN; }
function median(arr){
  if(!arr.length) return NaN;
  const a=[...arr].sort((x,y)=>x-y);
  const mid=Math.floor(a.length/2);
  return (a.length%2) ? a[mid] : (a[mid-1]+a[mid])/2;
}

/* ===========================
   Storage keys
=========================== */
// salvate (training)
const LS_SAVED = "doomsday_saved_v1";

// training stats
const LS_TRAIN_TIMES = "doomsday_training_times_v2";
const LS_TRAIN_STATS_ON = "doomsday_training_stats_on_v2";

// quiz progress + stats
const LS_QUIZ_PROG = "doomsday_quiz_progress_v2";      // n, ok, streak, bestStreak
const LS_QUIZ_TIMES = "doomsday_quiz_times_v2";
const LS_QUIZ_ERRORS = "doomsday_quiz_errors_v2";      // map errori con okStreak per regola C
const LS_QUIZ_STATS_ON = "doomsday_quiz_stats_on_v2";

/* ===========================
   Load / Save
=========================== */
function keyOf(y,m,d){ return `${y}-${String(m).padStart(2,"0")}-${String(d).padStart(2,"0")}`; }

function loadArr(key){
  try{
    const raw=localStorage.getItem(key);
    const arr=raw?JSON.parse(raw):[];
    return Array.isArray(arr)?arr:[];
  }catch(e){ return []; }
}
function saveArr(key, arr, cap){
  try{
    const out = (cap && arr.length>cap) ? arr.slice(arr.length-cap) : arr;
    localStorage.setItem(key, JSON.stringify(out));
  }catch(e){}
}
function loadBool(key, def=false){
  try{
    const raw=localStorage.getItem(key);
    if(raw===null) return def;
    return raw==="1";
  }catch(e){ return def; }
}
function saveBool(key, v){
  try{ localStorage.setItem(key, v?"1":"0"); }catch(e){}
}

function loadSaved(){
  try{
    const raw=localStorage.getItem(LS_SAVED);
    const arr=raw?JSON.parse(raw):[];
    return Array.isArray(arr)?arr:[];
  }catch(e){ return []; }
}
function saveSaved(arr){
  try{ localStorage.setItem(LS_SAVED, JSON.stringify(arr)); }catch(e){}
}

function loadQuizProg(){
  try{
    const raw=localStorage.getItem(LS_QUIZ_PROG);
    const o=raw?JSON.parse(raw):null;
    if(!o || typeof o!=="object") return {n:0, ok:0, streak:0, bestStreak:0};
    return {
      n: Number.isFinite(o.n)?o.n:0,
      ok: Number.isFinite(o.ok)?o.ok:0,
      streak: Number.isFinite(o.streak)?o.streak:0,
      bestStreak: Number.isFinite(o.bestStreak)?o.bestStreak:0
    };
  }catch(e){ return {n:0, ok:0, streak:0, bestStreak:0}; }
}
function saveQuizProg(o){
  try{ localStorage.setItem(LS_QUIZ_PROG, JSON.stringify(o)); }catch(e){}
}

// error map: { "YYYY-MM-DD": {y,m,d, wrongCount, okStreak} }
function loadErrMap(){
  try{
    const raw=localStorage.getItem(LS_QUIZ_ERRORS);
    const parsed=raw?JSON.parse(raw):null;
    if(!parsed || typeof parsed!=="object" || Array.isArray(parsed)) return {};
    const map={};
    for(const [k,v] of Object.entries(parsed)){
      if(!v || typeof v!=="object") continue;
      const y=Number(v.y), m=Number(v.m), d=Number(v.d);
      if(!Number.isFinite(y)||!Number.isFinite(m)||!Number.isFinite(d)) continue;
      map[k]={
        y,m,d,
        wrongCount: Number.isFinite(v.wrongCount)?v.wrongCount:1,
        okStreak: Number.isFinite(v.okStreak)?v.okStreak:0
      };
    }
    return map;
  }catch(e){ return {}; }
}
function saveErrMap(map){
  try{ localStorage.setItem(LS_QUIZ_ERRORS, JSON.stringify(map)); }catch(e){}
}

/* ===========================
   DOM
=========================== */
const tabTraining=document.getElementById("tabTraining");
const tabQuiz=document.getElementById("tabQuiz");
const tabVerify=document.getElementById("tabVerify");

const statsToggle=document.getElementById("statsToggle");
const statsToggleLabel=document.getElementById("statsToggleLabel");

const setupRadios=document.getElementById("setupRadios");
const setupClearBtn=document.getElementById("setupClearBtn");

const minY=document.getElementById("minY");
const maxY=document.getElementById("maxY");
const mode1900=document.getElementById("mode1900");
const fmtNum=document.getElementById("fmtNum");
const rangeBlock=document.getElementById("rangeBlock");

const mainCard=document.getElementById("mainCard");
const dateOut=document.getElementById("dateOut");

const trainingBlock=document.getElementById("trainingBlock");
const answerOut=document.getElementById("answerOut");
const saveBtn=document.getElementById("saveBtn");

const quizBlock=document.getElementById("quizBlock");
const quizRows=document.getElementById("quizRows");
const quizMsg=document.getElementById("quizMsg");

const verifyBlock=document.getElementById("verifyBlock");
const verifyIn=document.getElementById("verifyIn");
const verifyBtn=document.getElementById("verifyBtn");
const verifyOut=document.getElementById("verifyOut");

const trainingStatsCard=document.getElementById("trainingStatsCard");
const tNOut=document.getElementById("tNOut");
const tTimeTop=document.getElementById("tTimeTop");
const tAvgOut=document.getElementById("tAvgOut");
const tMedOut=document.getElementById("tMedOut");
const tBestOut=document.getElementById("tBestOut");
const tWorstOut=document.getElementById("tWorstOut");
const tResetBtn=document.getElementById("tResetBtn");

const quizStatsCard=document.getElementById("quizStatsCard");
const qTopLeft=document.getElementById("qTopLeft");
const qTimeTop=document.getElementById("qTimeTop");
const qStreakOut=document.getElementById("qStreakOut");
const qBestStreakOut=document.getElementById("qBestStreakOut");
const qSessionOut=document.getElementById("qSessionOut");
const qErrCountOut=document.getElementById("qErrCountOut");
const qAvgOut=document.getElementById("qAvgOut");
const qMedOut=document.getElementById("qMedOut");
const qBestOut=document.getElementById("qBestOut");
const qWorstOut=document.getElementById("qWorstOut");
const qResetBtn=document.getElementById("qResetBtn");

const bottomBar=document.getElementById("bottomBar");
const bottomBtn=document.getElementById("bottomBtn");

/* ===========================
   State
=========================== */
let mode = "training";           // training | quiz | verify
let cur = null;
let revealed = false;            // training only
let quizLocked = false;          // quiz answered

let saved = loadSaved();

// Training stats
let tTimes = loadArr(LS_TRAIN_TIMES).filter(Number.isFinite);
let tStatsOn = loadBool(LS_TRAIN_STATS_ON, false);
let tPendingStart = false;

// Quiz stats
let qProg = loadQuizProg();
let qTimes = loadArr(LS_QUIZ_TIMES).filter(Number.isFinite);
let qErrMap = loadErrMap();
let qStatsOn = loadBool(LS_QUIZ_STATS_ON, false);
let qPendingStart = false;
let lastErrKey = null;

// Timers (live)
let tStart = null;
let timerInterval = null;

/* ===========================
   Timer helpers
=========================== */
function stopLiveTimer(){
  if(timerInterval) clearInterval(timerInterval);
  timerInterval = null;
}
function startLiveTimer(targetEl){
  stopLiveTimer();
  timerInterval = setInterval(()=>{
    if(!tStart) return;
    const s = (performance.now()-tStart)/1000;
    targetEl.textContent = fmtSec(s) + " s";
  }, 100);
}

/* ===========================
   Setup UI builders
=========================== */
function buildSetupRadios(){
  setupRadios.innerHTML = "";
  setupClearBtn.style.display = "none";
  setupClearBtn.textContent = "—";

  const mkRadio = (name, value, text, countSpanId=null) => {
    const lab = document.createElement("label");
    lab.className = "inline";
    const inp = document.createElement("input");
    inp.type="radio";
    inp.name=name;
    inp.value=value;
    lab.appendChild(inp);

    const t = document.createElement("span");
    t.textContent = text;
    lab.appendChild(t);

    if(countSpanId){
      const sp = document.createElement("span");
      sp.id = countSpanId;
      sp.textContent = "0";
      lab.appendChild(document.createTextNode(" ("));
      lab.appendChild(sp);
      lab.appendChild(document.createTextNode(")"));
    }

    return {lab, inp};
  };

  if(mode === "training"){
    const r1 = mkRadio("srcMode","range","Range");
    const r2 = mkRadio("srcMode","saved","Salvate", "savedCount");
    r1.inp.checked = true;

    setupRadios.appendChild(r1.lab);
    setupRadios.appendChild(r2.lab);

    setupClearBtn.textContent = "Svuota salvate";
    setupClearBtn.onclick = clearSaved;
    setupClearBtn.style.display = (saved.length>0) ? "inline-block" : "none";
  }

  if(mode === "quiz"){
    const r1 = mkRadio("quizSrc","range","Range");
    const r2 = mkRadio("quizSrc","errors","Errori", "errCount");
    r1.inp.checked = true;

    setupRadios.appendChild(r1.lab);
    setupRadios.appendChild(r2.lab);

    setupClearBtn.textContent = "Svuota errori";
    setupClearBtn.onclick = clearErrors;
    setupClearBtn.style.display = (Object.keys(qErrMap).length>0) ? "inline-block" : "none";
  }

  if(mode === "verify"){
    // niente radio in verifica
    setupRadios.innerHTML = "";
    setupClearBtn.style.display = "none";
  }

  // listeners radio
  [...setupRadios.querySelectorAll("input[type=radio]")].forEach(inp=>{
    inp.addEventListener("change", ()=>{
      syncSetupEnabled();
      newDate();
    });
  });

  refreshCounts();
}

function refreshCounts(){
  const sc = document.getElementById("savedCount");
  if(sc) sc.textContent = saved.length;

  const ec = document.getElementById("errCount");
  if(ec) ec.textContent = Object.keys(qErrMap).length;

  if(mode==="training"){
    setupClearBtn.style.display = (getTrainingSrc()==="saved" && saved.length>0) ? "inline-block" : "none";
  }
  if(mode==="quiz"){
    setupClearBtn.style.display = (getQuizSrc()==="errors" && Object.keys(qErrMap).length>0) ? "inline-block" : "none";
  }
}

function getTrainingSrc(){
  const sel = document.querySelector('input[name="srcMode"]:checked');
  return sel ? sel.value : "range";
}
function getQuizSrc(){
  const sel = document.querySelector('input[name="quizSrc"]:checked');
  return sel ? sel.value : "range";
}

function syncSetupEnabled(){
  const inVerify = (mode==="verify");
  document.getElementById("setupCard").style.display = inVerify ? "none" : "block";
}

function applyMode1900(){
  if(mode1900.checked){
    minY.value=1900;
    maxY.value=2099;
  }
}

function pickFromRange(){
  applyMode1900();
  const min=Number(minY.value), max=Number(maxY.value);
  if(!Number.isFinite(min)||!Number.isFinite(max)||min>max){
    alert("Intervallo anni non valido.");
    return null;
  }
  const y=randInt(min,max);
  const m=randInt(1,12);
  const d=randInt(1,dim(y,m));
  return {y,m,d};
}

function pickFromSaved(){
  if(saved.length===0) return null;
  return saved[randInt(0, saved.length-1)];
}

function pickFromErrors(){
  const keys = Object.keys(qErrMap);
  if(!keys.length) return null;

  let k = keys[randInt(0, keys.length-1)];
  if(keys.length>1 && k===lastErrKey){
    const alt = keys.find(x=>x!==lastErrKey);
    if(alt) k = alt;
  }
  lastErrKey = k;
  const e = qErrMap[k];
  return {y:e.y,m:e.m,d:e.d, _errKey:k};
}

function isSavedDate(y,m,d){
  const k=keyOf(y,m,d);
  return saved.some(x=>keyOf(x.y,x.m,x.d)===k);
}

/* ===========================
   Stats UI
=========================== */
function updateTrainingStatsUI(){
  if(!(mode==="training" && tStatsOn)){
    trainingStatsCard.style.display = "none";
    return;
  }
  trainingStatsCard.style.display = "block";

  const n=tTimes.length;
  tNOut.textContent = n;

  tAvgOut.textContent = fmtSec(mean(tTimes));
  tMedOut.textContent = fmtSec(median(tTimes));
  tBestOut.textContent = n ? fmtSec(Math.min(...tTimes)) : "—";
  tWorstOut.textContent = n ? fmtSec(Math.max(...tTimes)) : "—";

  if(!tStart){
    const last = n ? tTimes[n-1] : NaN;
    tTimeTop.textContent = n ? (fmtSec(last)+" s") : "—";
  }
}

function updateQuizStatsUI(){
  if(!(mode==="quiz" && qStatsOn)){
    quizStatsCard.style.display = "none";
    return;
  }
  quizStatsCard.style.display = "block";

  const errN = Object.keys(qErrMap).length;
  qTopLeft.textContent = `OK ${qProg.ok}/${qProg.n}`;
  qStreakOut.textContent = qProg.streak;
  qBestStreakOut.textContent = qProg.bestStreak;
  qSessionOut.textContent = `${qProg.ok}/${qProg.n}`;
  qErrCountOut.textContent = errN;

  const n=qTimes.length;
  qAvgOut.textContent = fmtSec(mean(qTimes));
  qMedOut.textContent = fmtSec(median(qTimes));
  qBestOut.textContent = n ? fmtSec(Math.min(...qTimes)) : "—";
  qWorstOut.textContent = n ? fmtSec(Math.max(...qTimes)) : "—";

  if(!tStart){
    const last = n ? qTimes[n-1] : NaN;
    qTimeTop.textContent = n ? (fmtSec(last)+" s") : "—";
  }
}

/* ===========================
   Mode switch
=========================== */
function setMode(newMode){
  mode = newMode;

  tabTraining.classList.toggle("active", mode==="training");
  tabQuiz.classList.toggle("active", mode==="quiz");
  tabVerify.classList.toggle("active", mode==="verify");

  // blocks
  trainingBlock.style.display = (mode==="training") ? "block" : "none";
  quizBlock.style.display = (mode==="quiz") ? "block" : "none";
  verifyBlock.style.display = (mode==="verify") ? "block" : "none";

  // stats toggle label visibility
  statsToggleLabel.style.display = (mode==="verify") ? "none" : "flex";

  // bottom bar visibility
  bottomBar.style.display = (mode==="verify") ? "none" : "flex";

  // reset UI states
  clearResultColor();
  quizMsg.textContent = "";
  answerOut.textContent = "";
  verifyOut.textContent = "";
  saveBtn.style.display = "none";

  revealed = false;
  quizLocked = false;

  // apply stats checkbox for this mode
  if(mode==="training"){
    statsToggle.checked = tStatsOn;
  }else if(mode==="quiz"){
    statsToggle.checked = qStatsOn;
  }

  buildSetupRadios();
  syncSetupEnabled();

  stopLiveTimer();
  tStart = null;

  updateTrainingStatsUI();
  updateQuizStatsUI();

  if(mode!=="verify"){
    newDate();
  }
}

/* ===========================
   Bottom button behavior
=========================== */
function setBottom(){
  bottomBtn.disabled = !cur;

  if(!cur) return;

  if(mode==="training"){
    bottomBtn.textContent = revealed ? "Nuova data" : "Mostra";
    bottomBtn.className = revealed ? "bottomNext" : "";
    return;
  }

  if(mode==="quiz"){
    bottomBtn.textContent = quizLocked ? "Prossima data" : "Skip";
    bottomBtn.className = quizLocked ? "bottomNext" : "";
    return;
  }
}

function bottomAction(){
  if(!cur) return;

  if(mode==="training"){
    if(!revealed) revealTraining();
    else newDate();
    return;
  }

  if(mode==="quiz"){
    newDate(); // skip o prossima
    return;
  }
}

/* ===========================
   Training logic
=========================== */
function revealTraining(){
  if(!cur) return;

  // se stats ON e timer attivo => salva tempo
  if(tStatsOn && tStart){
    const elapsed = (performance.now()-tStart)/1000;
    tTimes.push(elapsed);
    saveArr(LS_TRAIN_TIMES, tTimes, 5000);
    tStart=null;
    stopLiveTimer();
    updateTrainingStatsUI();
  }

  const w = weekday(cur.y,cur.m,cur.d);
  const leap = isLeap(cur.y);
  answerOut.innerHTML = giorni[w] + (leap ? `<div class="leapNote">bisestile</div>` : "");

  revealed = true;
  setBottom();

  // save button
  const already = isSavedDate(cur.y,cur.m,cur.d);
  saveBtn.textContent = already ? "Rimuovi" : "Salva";
  saveBtn.style.display = "inline-block";
}

function toggleSave(){
  if(!cur) return;
  const k = keyOf(cur.y,cur.m,cur.d);
  const already = isSavedDate(cur.y,cur.m,cur.d);
  if(already){
    saved = saved.filter(x => keyOf(x.y,x.m,x.d)!==k);
  }else{
    saved.push({y:cur.y,m:cur.m,d:cur.d});
  }
  saveSaved(saved);
  refreshCounts();
  if(mode==="training" && revealed){
    saveBtn.textContent = already ? "Salva" : "Rimuovi";
  }
}

function clearSaved(){
  if(saved.length===0) return;
  if(!confirm("Svuotare tutte le salvate?")) return;
  saved = [];
  saveSaved(saved);
  refreshCounts();
  if(mode==="training" && getTrainingSrc()==="saved"){
    newDate();
  }
}

/* ===========================
   Quiz logic
=========================== */
function buildQuizButtons(){
  quizRows.innerHTML = "";

  const makeBtn = (idx) => {
    const b=document.createElement("button");
    b.className="quizBtn";
    b.textContent=giorni[idx];
    b.addEventListener("click", ()=>quizAnswer(idx));
    return b;
  };

  const r1=document.createElement("div"); r1.className="quizRow";
  r1.appendChild(makeBtn(0)); // Dom
  r1.appendChild(makeBtn(1)); // Lun

  const r2=document.createElement("div"); r2.className="quizRow";
  r2.appendChild(makeBtn(2)); // Mar
  r2.appendChild(makeBtn(3)); // Mer
  r2.appendChild(makeBtn(4)); // Gio

  const r3=document.createElement("div"); r3.className="quizRow";
  r3.appendChild(makeBtn(5)); // Ven
  r3.appendChild(makeBtn(6)); // Sab

  quizRows.appendChild(r1);
  quizRows.appendChild(r2);
  quizRows.appendChild(r3);
}

function setQuizButtonsEnabled(on){
  [...quizRows.querySelectorAll("button")].forEach(b=>b.disabled=!on);
}

function clearErrors(){
  const n = Object.keys(qErrMap).length;
  if(!n) return;
  if(!confirm("Svuotare tutti gli errori?")) return;
  qErrMap = {};
  saveErrMap(qErrMap);
  refreshCounts();
  if(mode==="quiz" && getQuizSrc()==="errors"){
    // torna a range automaticamente
    const r = document.querySelector('input[name="quizSrc"][value="range"]');
    if(r) r.checked = true;
    buildSetupRadios();
  }
  newDate();
}

function resetQuizStats(){
  if(!confirm("Reset quiz? (progressi, tempi, errori)")) return;
  qProg = {n:0, ok:0, streak:0, bestStreak:0};
  qTimes = [];
  qErrMap = {};
  saveQuizProg(qProg);
  saveArr(LS_QUIZ_TIMES, qTimes, 5000);
  saveErrMap(qErrMap);
  refreshCounts();
  updateQuizStatsUI();
  newDate();
}

function updateErrorMapAfterAnswer(ok){
  if(!qStatsOn) return; // stats OFF => niente tempi + niente errori

  const k = keyOf(cur.y,cur.m,cur.d);
  const ex = qErrMap[k];

  if(ok){
    if(ex){
      ex.okStreak = (ex.okStreak||0) + 1;
      if(ex.okStreak >= 2){
        delete qErrMap[k]; // regola C
      }else{
        qErrMap[k] = ex;
      }
      saveErrMap(qErrMap);
    }
    return;
  }

  // wrong
  const e = ex ? ex : {y:cur.y,m:cur.m,d:cur.d, wrongCount:0, okStreak:0};
  e.wrongCount = (e.wrongCount||0) + 1;
  e.okStreak = 0;
  qErrMap[k]=e;
  saveErrMap(qErrMap);
}

function quizAnswer(chosenIdx){
  if(!cur || quizLocked) return;

  const correctIdx = weekday(cur.y,cur.m,cur.d);
  const ok = (chosenIdx === correctIdx);

  // progress sempre
  qProg.n += 1;
  if(ok){
    qProg.ok += 1;
    qProg.streak += 1;
    if(qProg.streak > qProg.bestStreak) qProg.bestStreak = qProg.streak;
  }else{
    qProg.streak = 0;
  }
  saveQuizProg(qProg);

  // tempi solo se stats ON e timer attivo
  if(qStatsOn && tStart){
    const elapsed=(performance.now()-tStart)/1000;
    qTimes.push(elapsed);
    saveArr(LS_QUIZ_TIMES, qTimes, 5000);
  }

  updateErrorMapAfterAnswer(ok);

  // stop timer
  tStart=null;
  stopLiveTimer();

  // lock + feedback
  quizLocked = true;
  setQuizButtonsEnabled(false);

  // colore box + testo
  clearResultColor();
  mainCard.classList.add(ok ? "mainOk" : "mainBad");

  const leap = isLeap(cur.y);
  quizMsg.innerHTML = (ok ? "Corretto" : "Errato.") +
    `<div style="font-size:22px;font-weight:900;margin-top:10px;">${giorni[correctIdx]}</div>` +
    (leap ? `<div class="leapNote">bisestile</div>` : "");

  refreshCounts();
  updateQuizStatsUI();
  setBottom();
}

/* ===========================
   Common: new date
=========================== */
function clearResultColor(){
  mainCard.classList.remove("mainOk","mainBad");
}

function newDate(){
  clearResultColor();

  let next=null;

  if(mode==="training"){
    if(getTrainingSrc()==="saved"){
      next = pickFromSaved();
      if(!next){
        alert("Nessuna data salvata. Passo a Range.");
        const r = document.querySelector('input[name="srcMode"][value="range"]');
        if(r) r.checked = true;
        buildSetupRadios();
        next = pickFromRange();
      }
    }else{
      next = pickFromRange();
    }
  }

  if(mode==="quiz"){
    if(getQuizSrc()==="errors"){
      next = pickFromErrors();
      if(!next){
        alert("Nessun errore salvato. Passo a Range.");
        const r = document.querySelector('input[name="quizSrc"][value="range"]');
        if(r) r.checked = true;
        buildSetupRadios();
        next = pickFromRange();
      }
    }else{
      next = pickFromRange();
    }
  }

  if(!next) return;

  cur = {y:next.y,m:next.m,d:next.d};
  revealed = false;
  quizLocked = false;

  // render
  dateOut.textContent = fmtDate(cur.d,cur.m,cur.y);
  answerOut.textContent = "";
  quizMsg.textContent = "";
  verifyOut.textContent = "";

  // buttons
  saveBtn.style.display = "none";
  if(mode==="quiz") setQuizButtonsEnabled(true);

  // timer rules:
  // - se stats ON: parte solo se NON "pendingStart" e se già attivo da prima
  // - se "pendingStart" è true => parte ora e poi pending=false
  stopLiveTimer();
  tStart = null;

  if(mode==="training" && tStatsOn){
    if(tPendingStart){
      tPendingStart=false;
      tStart=performance.now();
      startLiveTimer(tTimeTop);
    }else{
      // timer attivo normalmente a ogni nuova data (dopo che l'hai abilitato)
      tStart=performance.now();
      startLiveTimer(tTimeTop);
    }
  }

  if(mode==="quiz" && qStatsOn){
    if(qPendingStart){
      qPendingStart=false;
      tStart=performance.now();
      startLiveTimer(qTimeTop);
    }else{
      tStart=performance.now();
      startLiveTimer(qTimeTop);
    }
  }

  updateTrainingStatsUI();
  updateQuizStatsUI();
  setBottom();
}

/* ===========================
   Verify
=========================== */
function parseDDMMYYYY(s){
  const t = (s||"").trim();
  const m = t.match(/^(\d{1,2})[\/\-\.\s](\d{1,2})[\/\-\.\s](\d{4})$/);
  if(!m) return null;
  const d = Number(m[1]), mo = Number(m[2]), y = Number(m[3]);
  if(!(Number.isFinite(d)&&Number.isFinite(mo)&&Number.isFinite(y))) return null;
  if(mo<1||mo>12) return null;
  if(d<1||d>dim(y,mo)) return null;
  return {d, m:mo, y};
}

function doVerify(){
  const p = parseDDMMYYYY(verifyIn.value);
  if(!p){
    verifyOut.textContent = "Data non valida.";
    return;
  }
  const w = weekday(p.y,p.m,p.d);
  const leap = isLeap(p.y);
  verifyOut.innerHTML = `${giorni[w]}<div class="leapNote">${leap ? "bisestile" : "non bisestile"}</div>`;
}

/* ===========================
   Stats toggle handler
=========================== */
function onStatsToggleChanged(){
  if(mode==="training"){
    const newVal = statsToggle.checked;
    if(newVal === tStatsOn) return;
    tStatsOn = newVal;
    saveBool(LS_TRAIN_STATS_ON, tStatsOn);

    // regola: se attivi ORA, timer parte dalla prossima data
    stopLiveTimer();
    tStart = null;
    if(tStatsOn){
      tPendingStart = true;
    }else{
      tPendingStart = false;
    }
    updateTrainingStatsUI();
    setBottom();
    return;
  }

  if(mode==="quiz"){
    const newVal = statsToggle.checked;
    if(newVal === qStatsOn) return;
    qStatsOn = newVal;
    saveBool(LS_QUIZ_STATS_ON, qStatsOn);

    // regola: se attivi ORA, timer parte dalla prossima data
    stopLiveTimer();
    tStart = null;
    if(qStatsOn){
      qPendingStart = true;
    }else{
      qPendingStart = false;
    }
    updateQuizStatsUI();
    setBottom();
    return;
  }
}

/* ===========================
   Events
=========================== */
tabTraining.addEventListener("click", ()=>setMode("training"));
tabQuiz.addEventListener("click", ()=>setMode("quiz"));
tabVerify.addEventListener("click", ()=>setMode("verify"));

statsToggle.addEventListener("change", onStatsToggleChanged);

mode1900.addEventListener("change", ()=>{ applyMode1900(); if(mode!=="verify") newDate(); });
fmtNum.addEventListener("change", ()=>{ if(cur) dateOut.textContent = fmtDate(cur.d,cur.m,cur.y); });

bottomBtn.addEventListener("click", bottomAction);

saveBtn.addEventListener("click", toggleSave);

tResetBtn.addEventListener("click", ()=>{
  if(!confirm("Reset statistiche training?")) return;
  tTimes = [];
  saveArr(LS_TRAIN_TIMES, tTimes, 5000);
  stopLiveTimer();
  tStart=null;
  updateTrainingStatsUI();
});

qResetBtn.addEventListener("click", resetQuizStats);

verifyBtn.addEventListener("click", doVerify);
verifyIn.addEventListener("keydown", (e)=>{
  if(e.key==="Enter") doVerify();
});

/* ===========================
   Init
=========================== */
function init(){
  // stats toggles
  tStatsOn = loadBool(LS_TRAIN_STATS_ON, false);
  qStatsOn = loadBool(LS_QUIZ_STATS_ON, false);

  buildQuizButtons();

  // start on training
  setMode("training");

  // SW
  if("serviceWorker" in navigator){
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  }
}

init();
</script>

</body>
</html>
