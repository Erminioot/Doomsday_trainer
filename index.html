<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Doomsday Trainer</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#ffffff">

  <style>
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      margin:18px;
      max-width:760px;
      padding-bottom:160px; /* riserva spazio per bottomBar */
    }
    h1{font-size:22px;margin:0 0 6px;}
    .muted{color:#555;font-size:14px;margin:0 0 14px;}

    .card{border:1px solid #ddd;border-radius:14px;padding:14px;margin:12px 0;}
    .row{display:flex;gap:14px;flex-wrap:wrap;align-items:center;}
    label{font-size:14px;display:flex;align-items:center;gap:8px;}

    input[type="number"]{
      font-size:18px;padding:10px;border-radius:10px;border:1px solid #ccc;width:120px;
    }
    input[type="checkbox"],input[type="radio"]{transform:scale(1.15);}

    button{
      font-size:18px;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid #bbb;
      background:#fff;
      cursor:pointer;
    }
    button:active{transform:translateY(1px);}
    button:disabled{opacity:.45; cursor:not-allowed;}

    /* Date card */
    .date{font-size:44px;font-weight:800;text-align:center;margin:18px 0 6px;}
    .answer{
      font-size:28px;
      font-weight:700;
      text-align:center;
      margin:8px 0 14px;
      line-height:1.15;
    }
    .leapNote{
      font-size:16px;
      font-style:italic;
      font-weight:400;
      margin-top:6px;
      color:#444;
    }

    /* Setup: Range grid */
    .rangeGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      align-items:center;
      margin-top:10px;
    }
    .mode1900Wrap{
      grid-column:1 / -1;  /* checkbox sotto */
      margin-top:2px;
    }

    .setupDisabled{
      opacity:.55;
      pointer-events:none;
    }

    /* Track toggle line (between cards) */
    .trackLine{
      display:flex;
      align-items:center;
      gap:10px;
      margin:10px 4px;
    }

    /* Save button under answer */
    .saveWrap{
      display:flex;
      justify-content:center;
      margin-top:6px;
    }
    .btnSmall{
      font-size:18px;
      padding:10px 14px;
      border-radius:12px;
      border:1px solid #bbb;
      background:#fff;
      font-weight:600;
    }
    .btnOk, .btnDanger{
      background:#fff;
      border:1px solid #bbb;
      color:#000;
      font-weight:600;
    }

    /* Source row (Range/Salvate + clear button on right) */
    .srcTopRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .srcLeft{
      display:flex;
      align-items:center;
      gap:18px;
      flex-wrap:wrap;
    }

    /* STATS (layout) */
    .statsTopRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .statsTopLeft{
      font-size:16px;
      font-weight:600;
      white-space:nowrap;
    }
    .statsTopMid{
      flex:1;
      text-align:center;
      font-size:24px;
      font-weight:800;
      text-decoration:underline;
      white-space:nowrap;
    }

    #statsCard .statsBox{
      border:1px solid #ddd;
      border-radius:12px;
      padding:12px 14px;
      margin-top:12px;
      display:grid !important;
      grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
      gap:10px 18px !important;
    }
    #statsCard .statRow{
      display:flex !important;
      justify-content:space-between !important;
      gap:10px !important;
      font-size:16px;
    }

    /* Bottom bar: fixed, stable position */
    .bottomBar{
      position:fixed;
      left:0; right:0; bottom:160px;
      background:#fff;
      padding:10px;
      display:flex;
      justify-content:center;
      z-index:999;
      border-top:1px solid #eee;
      padding-bottom: calc(10px + env(safe-area-inset-bottom));
    }
    .bottomBar button{
      font-size:22px;
      padding:26px 22px;
      width:92%;
      max-width:520px;
      border-radius:16px;
    }
    .bottomReveal{font-weight:800;}
    .bottomNext{
      background:#eaf7ea;
      border-color:#1f7a1f;
      font-weight:900;
    }
  </style>
</head>

<body>
  <h1>Doomsday Trainer</h1>
  <p class="muted">by L. Marenco</p>

  <!-- SETUP -->
  <div class="card">
    <div class="srcTopRow">
      <div class="srcLeft">
        <label><input type="radio" name="srcMode" value="range" checked>Range</label>
        <label><input type="radio" name="srcMode" value="saved">Salvate (<span id="savedCount">0</span>)</label>
      </div>

      <button id="clearSavedBtn" class="btnSmall" style="display:none;">Svuota salvate</button>
    </div>

    <div id="rangeBlock">
      <div class="rangeGrid" id="rangeRow">
        <label>Min <input id="minY" type="number" value="1800"></label>
        <label>Max <input id="maxY" type="number" value="2199"></label>
        <label class="mode1900Wrap"><input id="mode1900" type="checkbox">1900–2099</label>
      </div>
    </div>

    <div class="row" style="margin-top:12px;">
      <strong>Formato data:</strong>
      <label><input id="fmtNum" type="checkbox">Usa dd/mm/yyyy</label>
    </div>
  </div>

  <!-- TRACK TOGGLE BETWEEN -->
  <label class="trackLine">
    <input id="track" type="checkbox">
    Attiva statistiche
  </label>

  <!-- DATE / ANSWER -->
  <div class="card">
    <div class="date" id="dateOut">—</div>
    <div class="answer" id="answerOut"></div>

    <div class="saveWrap">
      <button id="saveBtn" class="btnSmall btnOk" style="display:none;">Salva</button>
    </div>
  </div>

  <!-- STATS -->
  <div class="card" id="statsCard" style="display:none;">
    <div class="statsTopRow">
      <div class="statsTopLeft">Prove <span id="nTopOut">0</span></div>
      <div class="statsTopMid" id="timeTop">—</div>
      <button id="resetStatsBtn" class="btnSmall">Reset</button>
    </div>

    <div class="statsBox">
      <div class="statRow"><span>Media</span><strong id="avgOut">—</strong></div>
      <div class="statRow"><span>Mediana</span><strong id="medOut">—</strong></div>
      <div class="statRow"><span>Migliore</span><strong id="bestOut">—</strong></div>
      <div class="statRow"><span>Peggiore</span><strong id="worstOut">—</strong></div>
    </div>
  </div>

  <!-- BOTTOM BUTTON -->
  <div class="bottomBar">
    <button id="revealBtn" class="bottomReveal" disabled>Mostra</button>
  </div>

<script>
  // ====== Data helpers ======
  const giorni=["Domenica","Lunedì","Martedì","Mercoledì","Giovedì","Venerdì","Sabato"];
  const mesi=["gennaio","febbraio","marzo","aprile","maggio","giugno","luglio","agosto","settembre","ottobre","novembre","dicembre"];

  function randInt(a,b){return Math.floor(Math.random()*(b-a+1))+a;}
  function isLeap(y){return y%4===0 && (y%100!==0 || y%400===0);}
  function dim(y,m){return [31,isLeap(y)?29:28,31,30,31,30,31,31,30,31,30,31][m-1];}

  // Zeller (Gregorian): 0=Sun..6=Sat
  function weekday(y,m,d){
    if(m<3){m+=12;y--;}
    const K=y%100;
    const J=Math.floor(y/100);
    const h=(d+Math.floor((13*(m+1))/5)+K+Math.floor(K/4)+Math.floor(J/4)+5*J)%7;
    return [6,0,1,2,3,4,5][h];
  }

  function fmtDate(d,m,y){
    if(fmtNum && fmtNum.checked){
      return String(d).padStart(2,"0")+"/"+String(m).padStart(2,"0")+"/"+y;
    }
    return d+" "+mesi[m-1]+" "+y;
  }

  // ====== Stats helpers ======
  function fmtSec(x){ return Number.isFinite(x) ? x.toFixed(2) : "—"; }
  function mean(arr){
    if(arr.length===0) return NaN;
    return arr.reduce((s,v)=>s+v,0)/arr.length;
  }
  function median(arr){
    if(arr.length===0) return NaN;
    const a=[...arr].sort((x,y)=>x-y);
    const mid=Math.floor(a.length/2);
    return (a.length%2) ? a[mid] : (a[mid-1]+a[mid])/2;
  }

  // ====== localStorage salvate ======
  const LS_KEY = "doomsday_saved_v1";
  function keyOf(y,m,d){ return `${y}-${String(m).padStart(2,"0")}-${String(d).padStart(2,"0")}`; }

  function loadSaved(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    }catch(e){
      return [];
    }
  }
  function saveSaved(arr){
    localStorage.setItem(LS_KEY, JSON.stringify(arr));
  }
  function isSavedDate(y,m,d){
    const k = keyOf(y,m,d);
    return saved.some(x => keyOf(x.y,x.m,x.d) === k);
  }

  // ====== State ======
  let cur=null;
  let shown=false;

  // stats
  let tStart=null;
  let timerInterval=null;
  const times=[];

  // salvate
  let saved = loadSaved();

  // ====== DOM ======
  const minY=document.getElementById("minY");
  const maxY=document.getElementById("maxY");
  const mode1900=document.getElementById("mode1900");
  const rangeBlock=document.getElementById("rangeBlock");

  const fmtNum=document.getElementById("fmtNum");

  const track=document.getElementById("track");
  const statsCard=document.getElementById("statsCard");

  const dateOut=document.getElementById("dateOut");
  const answerOut=document.getElementById("answerOut");

  const revealBtn=document.getElementById("revealBtn");

  const saveBtn=document.getElementById("saveBtn");
  const clearSavedBtn=document.getElementById("clearSavedBtn");
  const savedCount=document.getElementById("savedCount");

  const resetStatsBtn=document.getElementById("resetStatsBtn");
  const nTopOut=document.getElementById("nTopOut");
  const timeTop=document.getElementById("timeTop");
  const avgOut=document.getElementById("avgOut");
  const medOut=document.getElementById("medOut");
  const bestOut=document.getElementById("bestOut");
  const worstOut=document.getElementById("worstOut");

  function getSrcMode(){
    return document.querySelector('input[name="srcMode"]:checked').value; // range | saved
  }

  function refreshSavedUI(){
    savedCount.textContent = saved.length;
    clearSavedBtn.style.display = (getSrcMode()==="saved" && saved.length>0) ? "inline-block" : "none";
  }

  // ====== UI behaviors ======
  function stopLiveTimer(){
    if(timerInterval) clearInterval(timerInterval);
    timerInterval=null;
  }
  function startLiveTimer(){
    stopLiveTimer();
    timerInterval=setInterval(()=>{
      if(!tStart) return;
      const s=(performance.now()-tStart)/1000;
      timeTop.textContent = fmtSec(s) + " s"; // NO label, just time
    },100);
  }

  function updateStatsUI(){
    if(!track.checked){
      statsCard.style.display="none";
      stopLiveTimer();
      return;
    }
    statsCard.style.display="block";

    const n=times.length;
    nTopOut.textContent = n;

    const avg=mean(times);
    const med=median(times);
    const best=n?Math.min(...times):NaN;
    const worst=n?Math.max(...times):NaN;
    const last=n?times[n-1]:NaN;

    avgOut.textContent=fmtSec(avg);
    medOut.textContent=fmtSec(med);
    bestOut.textContent=fmtSec(best);
    worstOut.textContent=fmtSec(worst);

    if(!(track.checked && tStart)){
      timeTop.textContent = n ? (fmtSec(last) + " s") : "—";
    }
  }

  function setBottom(){
    revealBtn.disabled=!cur;

    if(!cur) return;
    if(!shown){
      revealBtn.textContent="Mostra";
      revealBtn.className="bottomReveal";
    }else{
      revealBtn.textContent="Nuova data";
      revealBtn.className="bottomNext";
    }
  }

  function syncRangeEnabled(){
    const mode = getSrcMode();
    const inRange = (mode === "range");

    rangeBlock.classList.toggle("setupDisabled", !inRange);

    minY.disabled = !inRange;
    maxY.disabled = !inRange;
    mode1900.disabled = !inRange;

    clearSavedBtn.style.display = (mode==="saved" && saved.length>0) ? "inline-block" : "none";
  }

  function applyMode1900(){
    if(mode1900.checked){
      minY.value=1900;
      maxY.value=2099;
    }
  }

  function pickFromRange(){
    applyMode1900();

    const min=Number(minY.value);
    const max=Number(maxY.value);
    if(!Number.isFinite(min)||!Number.isFinite(max)||min>max){
      alert("Intervallo anni non valido.");
      return null;
    }

    const y=randInt(min,max);
    const m=randInt(1,12);
    const d=randInt(1,dim(y,m));
    return {y,m,d};
  }

  function pickFromSaved(){
    if(saved.length===0) return null;
    const i = randInt(0, saved.length-1);
    return saved[i];
  }

  function newDate(){
    let next=null;
    if(getSrcMode()==="saved"){
      next = pickFromSaved();
      if(!next){
        alert("Nessuna data salvata. Passo a Range.");
        document.querySelector('input[name="srcMode"][value="range"]').checked=true;
        syncRangeEnabled();
        next = pickFromRange();
      }
    }else{
      next = pickFromRange();
    }
    if(!next) return;

    cur = {y:next.y, m:next.m, d:next.d};
    shown=false;

    dateOut.textContent = fmtDate(cur.d,cur.m,cur.y);
    answerOut.textContent = "";

    saveBtn.style.display = "none";

    stopLiveTimer();
    tStart=null;
    if(track.checked){
      tStart=performance.now();
      startLiveTimer();
      statsCard.style.display="block";
    }

    setBottom();
  }

  function updateSaveButton(){
    if(!cur) return;
    const already = isSavedDate(cur.y, cur.m, cur.d);
    saveBtn.textContent = already ? "Rimuovi" : "Salva";
    saveBtn.className = "btnSmall " + (already ? "btnDanger" : "btnOk");
  }

  function reveal(){
    if(!cur) return;

    if(track.checked && tStart){
      const elapsed=(performance.now()-tStart)/1000;
      times.push(elapsed);
      tStart=null;
      stopLiveTimer();
      updateStatsUI();
    }

    const w = weekday(cur.y, cur.m, cur.d);
    const leap = isLeap(cur.y);

    answerOut.innerHTML = giorni[w] + (leap ? `<div class="leapNote">bisestile</div>` : "");

    shown=true;
    setBottom();

    updateSaveButton();
    saveBtn.style.display = "inline-block";
  }

  function bottomAction(){
    if(!cur) return;
    if(!shown) reveal();
    else newDate();
  }

  function toggleSave(){
    if(!cur) return;
    const k = keyOf(cur.y, cur.m, cur.d);
    const already = isSavedDate(cur.y, cur.m, cur.d);

    if(already){
      saved = saved.filter(x => keyOf(x.y,x.m,x.d) !== k);
    }else{
      saved.push({y:cur.y,m:cur.m,d:cur.d});
    }
    saveSaved(saved);
    refreshSavedUI();
    updateSaveButton();
    syncRangeEnabled();
  }

  function clearSaved(){
    if(saved.length===0) return;
    if(!confirm("Svuotare tutte le salvate?")) return;
    saved = [];
    saveSaved(saved);
    refreshSavedUI();
    syncRangeEnabled();
  }

  function resetStats(){
    times.length=0;
    stopLiveTimer();
    tStart=null;
    updateStatsUI();
  }

  // ====== Events ======
  document.querySelectorAll('input[name="srcMode"]').forEach(r=>{
    r.addEventListener("change", ()=>{
      syncRangeEnabled();
      refreshSavedUI();
      newDate();
    });
  });

  mode1900.addEventListener("change", ()=>{
    applyMode1900();
    newDate();
  });

  fmtNum.addEventListener("change", ()=>{
    if(cur) dateOut.textContent = fmtDate(cur.d,cur.m,cur.y);
  });

  track.addEventListener("change", ()=>{
    stopLiveTimer();
    tStart=null;
    updateStatsUI();
  });

  revealBtn.addEventListener("click", bottomAction);
  saveBtn.addEventListener("click", toggleSave);
  clearSavedBtn.addEventListener("click", clearSaved);
  resetStatsBtn.addEventListener("click", resetStats);

  // ====== Init ======
  refreshSavedUI();
  syncRangeEnabled();
  updateStatsUI();
  newDate();
</script>

</body>
</html>
